select * from [master].dbo.spt_values

/****** Object:  Audit [tstAudit]    Script Date: 9/15/2021 3:17:34 PM ******/

ALTER SERVER AUDIT [SQL_SRV_AUDIT] WITH (STATE = OFF)

DROP SERVER AUDIT [SQL_SRV_AUDIT]

CREATE SERVER AUDIT [SQL_SRV_AUDIT]
TO FILE 
(	FILEPATH = N'D:\AUDIT_SQL\'
	,MAXSIZE = 5000 MB
	,MAX_FILES = 10
	,RESERVE_DISK_SPACE = OFF
) WITH (QUEUE_DELAY = 1000, ON_FAILURE = CONTINUE, AUDIT_GUID = 'd350b872-c7c6-4b47-9293-5e46d71a5154')
/*WHERE ([class_type]<>(22604)
	and [class_type]<>(21059)
	and [class_type]<>(19283)
	and [class_type]<>(21843)
	and [class_type]<>(16964)
	and [class_type]<>(8275)
)*/
ALTER SERVER AUDIT [SQL_SRV_AUDIT] WITH (STATE = ON)
GO


USE [master]
GO

ALTER SERVER AUDIT SPECIFICATION [SQL_SRV_AUDIT_SPECIFICATION] WITH (STATE = OFF)
GO
DROP SERVER AUDIT SPECIFICATION [SQL_SRV_AUDIT_SPECIFICATION]
GO

CREATE SERVER AUDIT SPECIFICATION [SQL_SRV_AUDIT_SPECIFICATION]
FOR SERVER AUDIT [SQL_SRV_AUDIT]
ADD (SUCCESSFUL_LOGIN_GROUP),
ADD (FAILED_LOGIN_GROUP),
ADD (LOGOUT_GROUP),
ADD (LOGIN_CHANGE_PASSWORD_GROUP),	-- ??? ????????? ?????? ????? ? ??????? ?????????? ALTER LOGIN
ADD (APPLICATION_ROLE_CHANGE_PASSWORD_GROUP),	--??????? ?????????? ??? ????????? ?????? ??? ???? ??????????
ADD (AUDIT_CHANGE_GROUP),	--??????? ????????? ??? ????????, ????????? ??? ???????? ?????? ??????
--ADD (BACKUP_RESTORE_GROUP),	-- ??????? ?????????? ???????? ?????????? ??????????? ??? ??????????????

ADD (DATABASE_ROLE_MEMBER_CHANGE_GROUP),	--??????? ?????????? ?????? ???, ????? ??? ????? ??????????? ? ???? ???? ?????? ??? ????????? ?? ???
ADD (DATABASE_OBJECT_CHANGE_GROUP),	--??????? ?????????? ? ??? ??????, ????? ??? ??????? ???? ?????? (????????, ??? ?????) ??????????? ?????????? CREATE, ALTER ??? DROP
ADD (DATABASE_PRINCIPAL_CHANGE_GROUP), --??????? ????????? ??? ????????, ????????? ??? ???????? ?? ???? ?????? ??????????, ????? ??? ????????????
ADD (DATABASE_PERMISSION_CHANGE_GROUP), --??????? ????????? ? ??????, ????? ?????????? GRANT, REVOKE ??? DENY ???????? ??? ?????????? ?? ?????????? ?????????? ????? ?????????? Server
ADD (DATABASE_OBJECT_PERMISSION_CHANGE_GROUP), --??????? ????????? ? ??? ??????, ????? ??? ??????? ???? ?????? (????????, ?????? ??? ?????) ??????????? ?????????? GRANT, REVOKE ??? DENY
ADD (DBCC_GROUP),	--??????? ?????????? ??? ?????? ?????????? ????? ??????? DBCC

ADD (SCHEMA_OBJECT_CHANGE_GROUP),	-- ??????? ?????????? ? ?????? ?????????? ??? ????? ???????? CREATE, ALTER ??? DROP
--ADD (SCHEMA_OBJECT_ACCESS_GROUP),	--out select rezult
ADD (SCHEMA_OBJECT_PERMISSION_CHANGE_GROUP),	--??????? ????????? ??? ?????????? ?????????? GRANT, REVOKE ??? DENY ??? ??????? ?????
ADD (SERVER_OBJECT_PERMISSION_CHANGE_GROUP),	--??????? ????????? ? ??????, ????? ?????????? GRANT, REVOKE ??? DENY ???????? ??? ?????????? ?? ??????? ??????? ????? ??????????
ADD (SERVER_PERMISSION_CHANGE_GROUP),	--??????? ????????? ? ??????, ????? ?????????? GRANT, REVOKE ??? DENY ???????? ??? ?????????? ? ??????? ???????? ???????
ADD (SERVER_ROLE_MEMBER_CHANGE_GROUP),	-- ??????? ?????????? ??? ?????????? ??? ???????? ????? ????? ?? ???????????????? ???? ???????
ADD (SERVER_OBJECT_CHANGE_GROUP),	--??????? ????????? ??? ?????????? ???????? CREATE, ALTER ??? DROP ? ????????? ???????
ADD (SERVER_PRINCIPAL_CHANGE_GROUP)	--??????? ????????? ??? ????????, ????????? ? ???????? ?????????? ?? ?????? ???????
WITH (STATE = ON)
GO


/*USE [PSI]
GO
ALTER DATABASE AUDIT SPECIFICATION [SQL_DB_AUDIT_SPECIFICATION] WITH (STATE = OFF)
GO
DROP DATABASE AUDIT SPECIFICATION [SQL_DB_AUDIT_SPECIFICATION]
GO

CREATE DATABASE AUDIT SPECIFICATION [SQL_DB_AUDIT_SPECIFICATION]
FOR SERVER AUDIT [SQL_SRV_AUDIT]
ADD (DELETE ON DATABASE::[PSI] BY [db_accessadmin]),
ADD (EXECUTE ON DATABASE::[PSI] BY [db_accessadmin]),
ADD (INSERT ON DATABASE::[PSI] BY [db_accessadmin]),
ADD (REFERENCES ON DATABASE::[PSI] BY [db_accessadmin]),
ADD (SELECT ON DATABASE::[PSI] BY [db_accessadmin]),
ADD (UPDATE ON DATABASE::[PSI] BY [db_accessadmin])
WITH (STATE = ON)
GO*/

select *
from sys.objects


select *
from (
	select 
		f.session_id
		,f.object_id
		,'Audit' as "type_id"
		,case 
			when f.action_id in ('LGO', 'LO') then 'A1'
			when f.action_id in ('LGIS', 'LGSD') then 'A2'
			when f.action_id in ('LGIF') then 'A3'
			when f.action_id = 'CR' and tp.class_type_desc in ('SQL USER', 'SQL LOGIN', 'WINDOWS LOGIN', 'WINDOWS USER', 'USER') then 'B1'
			when f.action_id = 'G' then 'B3'
			when f.action_id in ('AL','LGDB','LGLG') and tp.class_type_desc in ('SQL LOGIN', 'SQL USER') then 'B5'
			when f.action_id = 'DR' and tp.class_type_desc in ('SQL USER', 'SQL LOGIN') then 'B7'
			when f.action_id in ('PWR', 'PWEX', 'PWPL')  and tp.class_type_desc = 'SQL LOGIN' then 'B9'
			when f.action_id = 'CR' and tp.class_type_desc = 'ROLE' then 'B11'
			when f.action_id = 'DR' and tp.class_type_desc = 'ROLE' then 'B13'
			when f.action_id in ('DPRL','APRL','R') and tp.class_type_desc in ('ROLE','SERVER ROLE','SERVER') then 'B0'
			when f.action_id in ('AL', 'AUSC') and tp.class_type_desc in ('SERVER AUDIT SPECIFICATION', 'SERVER AUDIT') then 'D3'
			when f.action_id = 'DR  ' and tp.class_type_desc = 'SERVER AUDIT' then 'D1'
		end as subtype_id
		,case when f.client_ip = 'local machine' then '10.56.120.38' else f.client_ip end as ip_address
		,f.server_principal_name as "user_login"
		,case 
			when act.name = 'LOGIN SUCCEEDED' then 'SUCCESS' 
			when act.name = 'LOGIN FAILED' then 'FAIL' 
			when act.name = 'LOGOUT' then 'SUCCESS'
		end as "status"
		,cast(f.event_time as datetime) as operation_date
		,case when f.action_id = 'LGIF' then lower(f.[statement]) end as reason
		,f.server_principal_name as editor_user_login
		,rol.role_name as editor_role
		,case 
			when f.action_id = 'G' then 
				case when len(f.target_server_principal_name) > 0 then f.target_server_principal_name else f.target_database_principal_name end
			when f.action_id in ('AL','LGDB','LGLG') and tp.class_type_desc in ('SQL LOGIN', 'SQL USER') then f.object_name 
			when f.action_id = 'DR' and tp.class_type_desc in ('SQL USER', 'SQL LOGIN') then f.object_name
		end as edited_user_login
		,case when f.action_id in ('CR') and tp.class_type_desc in ('SQL USER', 'SQL LOGIN', 'WINDOWS LOGIN', 'WINDOWS USER', 'USER', 'ROLE') then f.object_name end as created_role
		,case when f.action_id = 'DR' and tp.class_type_desc = 'ROLE' then f.object_name end as edited_role
		,'' as params
		,lower(f.[statement]) as "sql_text"
		,f.transaction_id

		--,f.target_database_principal_name
		--,f.target_server_principal_name
		--,f.database_name
		--,f.schema_name
		--,f.object_name
		--,act.action_id
		--,act.name
		--,tp.class_type_desc
	from sys.fn_get_audit_file('D:\AUDIT_SQL\*.sqlaudit', default, default) as f
	join (select distinct 
			action_id
			, name
		from sys.dm_audit_actions) act
		on act.action_id = f.action_id
	join sys.dm_audit_class_type_map tp
		on tp.class_type = f.class_type
	left join (
		select
			coalesce(l.name, u.name) us_name
			,case when (r.principal_id is null) then 'public' else r.name end role_name
		from sys.database_principals u
			left join (sys.database_role_members m join sys.database_principals r on m.role_principal_id = r.principal_id) on u.principal_id = m.member_principal_id
			left join sys.server_principals l on u.sid = l.sid
		where u.type <> 'R') as rol
		on rol.us_name = f.server_principal_name
	where 1=1
		and f.server_principal_name <> 'NT SERVICE\SQLTELEMETRY'
		and object_id >= 0
		--and tp.class_type_desc in ('SQL USER','ROLE','WINDOWS LOGIN','WINDOWS USER', 'SERVER','SERVER ROLE')
	--order by operation_date desc
) t
where t.subtype_id is not null
	

	
	

	/*
	APRL	ADD MEMBER	ROLE
	EX  	EXECUTE		FUNCTION SCALAR SQL
	EX  	EXECUTE		STORED PROCEDURE
	SL  	SELECT		VIEW
	DPRL	DROP MEMBER	SERVER ROLE
	G   	GRANT		SERVER
	CR  	CREATE		SQL USER
	LGDB	CHANGE DEFAULT DATABASE	SQL LOGIN
	LGLG	CHANGE DEFAULT LANGUAGE	SQL LOGIN
	PWEX	PASSWORD EXPIRATION	SQL LOGIN
	PWPL	PASSWORD POLICY	SQL LOGIN
	IN  	INSERT		TABLE
	AUSC	AUDIT SESSION CHANGED	SERVER AUDIT
	UP  	UPDATE	TABLE
	*/